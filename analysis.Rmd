---
title: "Data Analyst Skills Test (Health Manager Level 2)"
author: "Phillip Hungerford"
date: "24/08/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr) # for filtering and data manipulation
library(ggplot2) # for data visualisation
library(survival) # for survival analysis
library(survminer) # for plotting survival curves
```

# 1. Analysing Data

Please prepare code in R preferably to answer the following questions:

You will need to source data files (sim_av_patient.csv, sim_av_tumour.csv and other metadata files) from the UK synthetic cancer registry data (Simulacrum*) from (https://healthdatainsight.org.uk/project/the-simulacrum/).

a. What is the sex distribution of patients?
b. Prepare a dataset with all lung cancer patients (SITE_ICD10_O2_3CHAR= C34) and their cause of deaths.
c. Calculate the mean survival time in days for the lung cancer patients who were diagnosed in 2013.


## Dataset details
The Simulacrum is a dataset that contains artificial patient-like cancer data to help researchers gain insights.

Simulacrum contains 2013 – 2017 diagnoses and treatment follow up to March 2018. 

First we download the data and check it against the data dictionary. The Cancer Outcomes & Services Dataset (COSD) is comprised of patient level data (sim_av_patient) and tumour level data (sim_av_tumour). These two tables are linked by the patient IDs (PATIENTID).

["Figure 1. - Data linkage information"](images/simulacrum-schema.png)

Based on this information, we will download the data and check it against the data dictionary. 

```{r}
##############################################################################
# Prepare data
#=============================================================================
# Load patient level data with death information
sim_av_patient <- read.csv("simulacrum_release_v1.2.0.2017/data/sim_av_patient.csv", na.strings = c("", " "))

# load tumour level data with patient ID
sim_av_tumour <- read.csv("simulacrum_release_v1.2.0.2017/data/sim_av_tumour.csv", na.strings = c("", " "))

# inspect 
head(sim_av_patient)
head(sim_av_tumour)

# check columns match with data dictionary? Yes
```

Quickly check for missing values

```{r}
# check missing for key variables
na_count <-sapply(sim_av_patient, function(y) sum(length(which(is.na(y)))))
na_count <- data.frame(na_count)
print(na_count)


# check missing for key variables
na_count <-sapply(sim_av_tumour, function(y) sum(length(which(is.na(y)))))
na_count <- data.frame(na_count)
print(na_count)
```

For patient level data there is missing data for ethnicity, death causes (for those that have not died) and 3 for new vital status and vital status dates. 

For tumour level data there is some missing data for stage best system, scores and gleason variables.

We can also map values from the zlookup tables to our columns, which will make examining the data easier.

```{r}
#=============================================================================
# Map values
#-----------------------------------------------------------------------------
# clean vital status
zvitalstatus_lookup <- read.csv('simulacrum_release_v1.2.0.2017/data_dictionary_files/zvitalstatus_lookup.csv')

for (i in 1:nrow(zvitalstatus_lookup)){
  sim_av_patient$NEWVITALSTATUS[sim_av_patient$NEWVITALSTATUS == zvitalstatus_lookup$ZVITALSTATUSID[i]] <- zvitalstatus_lookup$SHORTDESC[i]
}

table(sim_av_patient$NEWVITALSTATUS)

#-----------------------------------------------------------------------------
# clean age
zsex_lookup <- read.csv('simulacrum_release_v1.2.0.2017/data_dictionary_files/zsex_lookup.csv')

for (i in 1:nrow(zsex_lookup)){
  sim_av_patient$SEX[sim_av_patient$SEX == zsex_lookup$ZSEXID[i]] <- zsex_lookup$SHORTDESC[i]
}

#-----------------------------------------------------------------------------
# clean ethnicity

zethnicity_lookup <- read.csv('simulacrum_release_v1.2.0.2017/data_dictionary_files/zethnicity_lookup.csv')

for (i in 1:nrow(zethnicity_lookup)){
  sim_av_patient$ETHNICITY[sim_av_patient$ETHNICITY == zethnicity_lookup$ZETHNICITYID[i]] <- zethnicity_lookup$SHORTDESC[i]
}

#-----------------------------------------------------------------------------
# Format columns to appropriate type

# make factors based on type
sim_av_patient <- sim_av_patient %>% mutate_at(c('SEX',
                                                 'ETHNICITY',
                                                 'NEWVITALSTATUS'), as.factor)
# Dates
sim_av_patient <- sim_av_patient %>% 
  mutate(
    VITALSTATUSDATE  = as.Date(VITALSTATUSDATE , format = "%Y-%m-%d")
  )

sim_av_tumour <- sim_av_tumour %>% 
  mutate(
    DIAGNOSISDATEBEST  = as.Date(DIAGNOSISDATEBEST , format = "%Y-%m-%d")
  )

#-----------------------------------------------------------------------------
# Check
str(sim_av_patient)
str(sim_av_tumour)
```

## a. What is the sex distribution of patients?

```{r}
##############################################################################
# 1.a. Sex distribution

#-----------------------------------------------------------------------------
# Calculate the n and percent of patients by gender
sex_dist <- sim_av_patient %>%
  count(SEX) %>%
  # count creates a column called 'n'
  mutate(Percent = round(n / sum(n) * 100,2),
         Patients = "All")

# show results
sex_dist

#-----------------------------------------------------------------------------
# Visualise the data

# 1.a. Sex distribution
sex_dist$label = paste0(sprintf("%.0f", sex_dist$Percent), "%")

# stacked bar    
ggplot(sex_dist, aes(x = Patients, y = Percent, fill = SEX)) + 
  geom_bar(position = "stack", stat='identity') + 
  geom_text(aes(label = label), position = position_stack(vjust = 0.5), size = 4) +
  labs(x = "",
       y = "Percent (%)",
      title="Sex Distribution of All Patients")

# could also visualise using a pie chart
ggplot(sex_dist, aes(x = Patients, y = Percent, fill = SEX)) + 
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start=0) +
  geom_text(aes(label = label), position = position_stack(vjust = 0.5), size = 4) +
  labs(x = "",
       y = "Percent (%)",
      title="Sex Distribution of All Patients")
```

We can see that the distribution of sex for this dataset is evenly split with only 2 patients that have not specified their gender.

## b. Prepare a dataset with all lung cancer patients (SITE_ICD10_O2_3CHAR= C34) and their cause of deaths.

This section requires a patient level dataset of those that have had lung cancer. Steps:
1. Find those that have had tumours relating to lung cancer
2. Extract patients in the patient level data that correspond to 1

```{r}
#=============================================================================
# 1. b. Prepare a dataset with all lung cancer patients (SITE_ICD10_O2_3CHAR= C34) and their cause of deaths.

#-----------------------------------------------------------------------------
# 1. Find those that have had tumours relating to lung cancer

# define our target ICD10 code for lung cancer (C34: Malignant neoplasm of bronchus and lung)
target <- "C34"

# Extract the IDs for patients with lung cancer tumours (There are 167233 patients that have lung cancer)
lung_cancer_patient_ids <- unique(sim_av_tumour$PATIENTID[sim_av_tumour$SITE_ICD10_O2_3CHAR == target])

#-----------------------------------------------------------------------------
# 2. Extract patients in the patient level data that correspond to 1.
lung_cancer_patients <- sim_av_patient[sim_av_patient$PATIENTID %in% lung_cancer_patient_ids,]

# check
head(lung_cancer_patients)
```

We now have all lung cancer patients with their id, sex, link number, ethnicity, cause of death, vital status and vital status date. 

## c. Calculate the mean survival time in days for the lung cancer patients who were diagnosed in 2013.

*Cohort*
The cohort for the survival analysis will be patients that have ever had a lung cancer diagnosis and were diagnosed in 2013. 

To calculate the mean survival time, we will conduct a survival analysis. In order to conduct a survival analysis we need to define: 
1. *Mean survival*: The average length of time from date of lung cancer diagnosis who are still alive.
2. *Target event*: The event of interest will be death status.
3. *Time origin*: The time at which follow-up time starts is the date of lung cancer diagnosis.
4. *Time scale*: Time will be days from time origin to time of event, and patients will be right censored (for those that are alive).

In order to do survival analysis, we also need to prepare the data a bit further. Key components for survival analysis are (for each subject i): 
1. Event time Ti
2. Censoring time Ci
3. Event indicator δi:
  - 1 if event observed (i.e. Ti≤Ci)
  - 0 if censored (i.e. Ti>Ci)
4. Observed time Yi=min(Ti,Ci)

The observed times and an event indicator are provided in the lung data. We will create:
- time: Survival time in days (Yi)
- status: censoring status 0=censored, 1=dead (δi)

Here we will be modeling survival for those that were diagnosed with lung cancer tumours from 2013. We need to therefore:
1. Find the first diagnosis date for lung cancer patients
1. Create status variable from NEWVITALSTATUS as Dead; 1 or censored; 0.
2. Create a time variable that shows the time from diagnosis until status. 

```{r}
#=============================================================================
# 1.c. Calculate the mean survival time in days for the lung cancer patients who were diagnosed in 2013.
#-----------------------------------------------------------------------------

# 1. Find the first diagnosis date for lung cancer patients

# get lung cancer tumours
lung_cancer_tumours <- sim_av_tumour[sim_av_tumour$SITE_ICD10_O2_3CHAR == target, ] # 169,118 rows
  
# from this tumour data, get the earliest date of diagnosis for each patient
first_diagnosis <- lung_cancer_tumours %>% 
  select(PATIENTID, DIAGNOSISDATEBEST) %>% 
  group_by(PATIENTID) %>%
  filter(DIAGNOSISDATEBEST == min(DIAGNOSISDATEBEST)) %>%
  distinct()

# check 
head(first_diagnosis) # 167333 rows, matches patient numbers. 

# merge patient diagnosis data to patient level data by patient id
lung_cancer_patients <- left_join(lung_cancer_patients, first_diagnosis,by="PATIENTID")

# check
head(lung_cancer_patients)
```

We now create our time variable for survival analysis. This will be shown in days (the time from first diagnosis to status date). We will also create our status variable that flags those that have died as 1 and those that are still alive as 0, as they are right censored.

Date variables:

* DIAGNOSISDATEBEST = diagnosis date
* VITALSTATUSDATE = date of vital status

```{r}
#-----------------------------------------------------------------------------
# format dates and calculate time from diagnosis to event
lung_cancer_patients <- lung_cancer_patients %>% mutate(
  DIAGNOSISDATEBEST = as.Date(DIAGNOSISDATEBEST, format = "%Y-%m-%d"),
  VITALSTATUSDATE = as.Date(VITALSTATUSDATE, format = "%Y-%m-%d"),
  time = as.numeric(difftime(VITALSTATUSDATE, DIAGNOSISDATEBEST, units = "days")),
  status = ifelse(NEWVITALSTATUS == "Dead",1,0)
)

# check
head(lung_cancer_patients)
```
Everything looks great! Now lets subset patients that were diagnosed in 2013. 

```{r}
#-----------------------------------------------------------------------------
# filter patients that were diagnosed in 2013 only as per condition. Of all the lung cancer patients, we only want those that were diagnosed in 2013. 
lung_cancer_patients_2013 <- lung_cancer_patients %>% filter(DIAGNOSISDATEBEST >= "2013-01-01" & DIAGNOSISDATEBEST <= "2013-12-31") # N = 35210

# See how many have died 
table(lung_cancer_patients_2013$NEWVITALSTATUS)
# Alive = 7792     
# Died = 27403
# Exit posting = 15

# Examine vital status. 
lung_cancer_deaths <- lung_cancer_patients_2013 %>%
  count(NEWVITALSTATUS) %>%
  # count creates a column called 'n'
  mutate(Percent = round(n / sum(n) * 100,2),
         Patients = "All")
# preview
lung_cancer_deaths

# add label for plot
lung_cancer_deaths$label = paste0(sprintf("%.0f", lung_cancer_deaths$Percent), "%")

# create stacked bar chart
ggplot(lung_cancer_deaths, aes(x = Patients, y = Percent, fill = NEWVITALSTATUS)) + 
  geom_bar(position = "stack", stat='identity') + 
  geom_text(aes(label = label), position = position_stack(vjust = 0.5), size = 4) +
  labs(x = "",
       y = "Percent (%)",
      title="Sex Distribution of All Patients")

```

We can see that 78% of patients that were diagnosed with lung cancer have died, with 22% alive or exit posting. 

*Model survival*

First we will calculate the survival probability for lung cancer patients. This shows the probability that a patient survives from the time origin (lung cancer diagnosis) to the event time. 

```{r}
#-----------------------------------------------------------------------------
# Survival analysis 

# Kaplan-Meier estimate can be obtained as numbers by using survfit 
om.fit <- survfit(Surv(time, status) ~ 1, data = lung_cancer_patients_2013) 

# Change color, linetype by strata, risk.table color by strata
ggsurvplot(om.fit,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", 
          linetype = "strata", 
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_bw() # Change ggplot2 theme
)

```

We can examine the cumulative events. 

```{r}
ggsurvplot(om.fit,
          conf.int = TRUE,
          risk.table.col = "strata",
          ggtheme = theme_bw(), # Change ggplot2 theme
          fun = "event")
```

```{r}
# calculate mean, median survival time
print(om.fit, print.rmean=TRUE)
```

Survival analysis shows that the median survival for 50% of patients is 312 days.

```{r}
#The mean survival time in lung cancer patients followed-up to 5 years
survival:::survmean(om.fit, rmean=5*365) [[1]]["*rmean"]
```

The restricted mean survival time for a 5-year period is 682 days (1.8 years).

# 2. Visualising Data
Using the UK synthetic cancer registry data (Simulacrum):

a. Visualise the proportion of all ethnic groups among non-British male patients. You can find ethnic information of patients in the data dictionary provided in the simulacrum dataset.

b. Explore the data to find an interesting or insightful aspect that you can then communicate visually. Be creative!

## a. Visualise the proportion of all ethnic groups among non-British male patients. You can find ethnic information of patients in the data dictionary provided in the simulacrum dataset.

```{r}
# Calculate the n and percent of patients by gender
eth_dist <- sim_av_patient %>%
  count(ETHNICITY) %>%
  # count creates a column called 'n'
  mutate(Percent = round(n / sum(n) * 100,2),
         Patients = "All")

# show results
eth_dist[order(eth_dist$Percent, decreasing =T), ]
```

Before sub-setting the data, we can see that the majority of patients are white British. This is expected as the data is simulated from real cancer data in the UK. This however, is an important factor to consider when conducting an analysis as this may show potential bias towards certain ethnicities. 

```{r}
# Calculate the n and percent of patients by gender
bysex <- sim_av_patient %>%
  group_by(ETHNICITY, SEX) %>%
  count(ETHNICITY, SEX)

bysex <- bysex %>% group_by(ETHNICITY) %>% mutate(Percent = (n/sum(n) * 100), Patients = "All")
bysex[order(bysex$n, decreasing =T), ]
```

We can see that most ethnicities are evenly split between genders. With the exception on white and black Caribbean's, mixed white and Asians, Chinese, and others showing slighter higher proportion of females.

```{r}
# We are interested in examining non-British males patients. The only identifier of British patients is via the ethnicity "WHITE BRITISH" and "English". Patients that are exclusively "WHITE" could cover those from other European regions 

exclusions <- c("WHITE BRITISH", "English")

# we create a not in for our exclusions filter
`%notin%` <- Negate(`%in%`)

# subset data
non_british_males <- sim_av_patient %>% filter(SEX == 'MALE' & ETHNICITY %notin% exclusions)

# Show patients that were non-british
cat("Out of the", length(unique(sim_av_patient$PATIENTID)), "patients, there are", length(unique(non_british_males$PATIENTID)), "that are non-british males.")
```

```{r}
# check distribution of ethnicities
table(non_british_males$ETHNICITY)
```

```{r}
# bar chart
p <- ggplot(data = subset(non_british_males, !is.na(non_british_males$ETHNICITY)), aes(x = ETHNICITY, fill=ETHNICITY)) + 
  geom_bar()

p + coord_flip()
```

There are a lot of groups for ethnicity. We can group a lot of them together to get five major groups.

```{r}
# White, black, asian, mixed, ethnic
white <- c("C ANY OTHER WHITE BACKGROUND", "WHITE BRITISH", "WHITE", "WHITE IRISH", "English")
black <- c("BLACK AFRICAN", "BLACK CARIBBEAN", "P ANY OTHER BLACK BACKGROUND")
mixed <- c("G ANY OTHER MIXED BACKGROUND", "MIXED WHITE AND BLACK AFRICAN", "MIXED WHITE AND ASIAN", "WHITE AND BLACK CARIBBEAN")
asian <- c("ASIAN PAKISTANI", "ASIAN BANGLADESHI", "L ANY OTHER ASIAN BACKGROUND", "ASIAN INDIAN", "CHINESE")
other <- c("8 OTHER", "S ANY OTHER ETHNIC GROUP")
notKnown <- c("NOT STATED", "X NOT KNOWN")


# create grouped variable
non_british_males$ethnicity_grouped <- NA
non_british_males$ethnicity_grouped[non_british_males$ETHNICITY %in% white] <- "WHITE"
non_british_males$ethnicity_grouped[non_british_males$ETHNICITY %in% black] <- "BLACK"
non_british_males$ethnicity_grouped[non_british_males$ETHNICITY %in% mixed] <- "MIXED"
non_british_males$ethnicity_grouped[non_british_males$ETHNICITY %in% asian] <- "ASIAN"
non_british_males$ethnicity_grouped[non_british_males$ETHNICITY %in% other] <- "OTHER"
non_british_males$ethnicity_grouped[non_british_males$ETHNICITY %in% notKnown] <- NA
non_british_males$ethnicity_grouped[is.na(non_british_males$ETHNICITY)] <- NA
```

View grouped ethnicities. 

```{r}
#-----------------------------------------------------------------------------
# bar chart
ggplot(data = subset(non_british_males,!is.na(non_british_males$ethnicity_grouped)), aes(x = ethnicity_grouped, fill=ethnicity_grouped)) + 
  geom_bar() + coord_flip() + labs(x = "Ethnicity Grouped", y = "Count", title = " Count of Ethnicities in Simulacrum") + scale_fill_discrete(name = "Ethnicity Grouped") 
```

White is still the most prominent group among non-British males, followed by Asian, Black, other and mixed. We can explore within each group.

```{r}
# Split by groups

# white
non_british_males %>% filter(!is.na(non_british_males$ethnicity_grouped) & non_british_males$ETHNICITY %in% white) %>% 
ggplot(aes(x = ETHNICITY, fill=ETHNICITY)) + 
  geom_bar() + coord_flip() + labs(x = "Ethnicity", y = "Count (N)", title = "Breakdown of White Ethnicities") + scale_fill_discrete(name = "Ethnicity") 

# black
non_british_males %>% filter(!is.na(non_british_males$ethnicity_grouped) & non_british_males$ETHNICITY %in% black) %>% 
ggplot(aes(x = ETHNICITY, fill=ETHNICITY)) + 
  geom_bar() + coord_flip() + labs(x = "Ethnicity", y = "Count (N)", title = "Breakdown of Black Ethnicities") + scale_fill_discrete(name = "Ethnicity") 

# asian 
non_british_males %>% filter(!is.na(non_british_males$ethnicity_grouped) & non_british_males$ETHNICITY %in% asian) %>% 
ggplot(aes(x = ETHNICITY, fill=ETHNICITY)) + 
  geom_bar() + coord_flip() + labs(x = "Ethnicity", y = "Count (N)", title = "Breakdown of Asian Ethnicities") + scale_fill_discrete(name = "Ethnicity") 

# mixed
non_british_males %>% filter(!is.na(non_british_males$ethnicity_grouped) & non_british_males$ETHNICITY %in% mixed) %>% 
ggplot(aes(x = ETHNICITY, fill=ETHNICITY)) + 
  geom_bar() + coord_flip() + labs(x = "Ethnicity", y = "Count (N)", title = "Breakdown of Mixed Ethnicities") + scale_fill_discrete(name = "Ethnicity") 

```

Asian indians make up most of the Asian category and black carribeans make up most of the black ethnic group. For thsoe that are mixed, other was the most prominent, followed by black and white caribbean.

## b. Explore the data to find an interesting or insightful aspect that you can then communicate visually. Be creative!

Here we will examine the ethnicity for our lung cancer patients that were diagnosed in 2013. Let's first apply the same grouping technique as above. 

```{r}
#=============================================================================
# 2.b. Explore: Group ethnicities

# White, black, asian, mixed, ethnic
white <- c("C ANY OTHER WHITE BACKGROUND", "WHITE BRITISH", "WHITE", "WHITE IRISH", "English")
black <- c("BLACK AFRICAN", "BLACK CARIBBEAN", "P ANY OTHER BLACK BACKGROUND")
mixed <- c("G ANY OTHER MIXED BACKGROUND", "MIXED WHITE AND BLACK AFRICAN", "MIXED WHITE AND ASIAN", "WHITE AND BLACK CARIBBEAN")
asian <- c("ASIAN PAKISTANI", "ASIAN BANGLADESHI", "L ANY OTHER ASIAN BACKGROUND", "ASIAN INDIAN", "CHINESE")
other <- c("8 OTHER", "S ANY OTHER ETHNIC GROUP")
notKnown <- c("NOT STATED", "X NOT KNOWN")


# create grouped variable
lung_cancer_patients_2013$ethnicity_grouped <- NA
lung_cancer_patients_2013$ethnicity_grouped[lung_cancer_patients_2013$ETHNICITY %in% white] <- "WHITE"
lung_cancer_patients_2013$ethnicity_grouped[lung_cancer_patients_2013$ETHNICITY %in% black] <- "BLACK"
lung_cancer_patients_2013$ethnicity_grouped[lung_cancer_patients_2013$ETHNICITY %in% mixed] <- "MIXED"
lung_cancer_patients_2013$ethnicity_grouped[lung_cancer_patients_2013$ETHNICITY %in% asian] <- "ASIAN"
lung_cancer_patients_2013$ethnicity_grouped[lung_cancer_patients_2013$ETHNICITY %in% other] <- "OTHER"
lung_cancer_patients_2013$ethnicity_grouped[lung_cancer_patients_2013$ETHNICITY %in% notKnown] <- NA
lung_cancer_patients_2013$ethnicity_grouped[is.na(lung_cancer_patients_2013$ETHNICITY)] <- NA

```

Count the ethnicities amongst lung cancer patients diagnosed in 2013. 

```{r}
lung_cancer_order <- 
  lung_cancer_patients_2013 %>%
  count(ethnicity_grouped) %>%
  mutate(Percent = round(n / sum(n) * 100,2),
         Patients = "All")

# add label for plot
lung_cancer_order[order(lung_cancer_order$Percent, decreasing = T),]
```

```{r}
# create stacked bar chart
ggplot(lung_cancer_order, aes(x = ethnicity_grouped, y = Percent, fill = ethnicity_grouped)) + 
  geom_bar(stat='identity') + coord_flip() + labs(x = "Ethnicity Grouped", y = "Count (N)", title = " Count of Ethnicities in Simulacrum") + scale_fill_discrete(name = "Ethnicity Grouped") 
```

Majority of the patients that were diagnosed with lung cancer in 2013 were white, followed by Asian, Black, other and mixed. 

We can also examine of these patients, what was the gender split by ethnicity.

```{r}
# Calculate the n of patients
bysex <- lung_cancer_patients_2013 %>%
  group_by(ethnicity_grouped, SEX) %>%
  count(ethnicity_grouped, SEX)

# Calculate the percent by group 
bysex <- bysex %>% group_by(ethnicity_grouped) %>% mutate(Percent = (n/sum(n) * 100), Patients = "All")
bysex[order(bysex$n, decreasing =T), ]

# add labels for plot
bysex$label = paste0(sprintf("%.0f", bysex$Percent), "%")

# create plot
ggplot(bysex, aes(x = ethnicity_grouped, y = Percent, fill = SEX)) + 
  geom_bar(position = "stack", stat='identity') + 
  geom_text(aes(label = label), position = position_stack(vjust = 0.5), size = 4) + coord_flip() + labs(x = "Ethnicity Grouped", y = "Percent (%)", title = " Gender Split by Ethnicity for Lung Cancer Patients Diagnosed in 2013") + scale_fill_discrete(name = "Ethnicity Grouped") 
```

Interestingly we can see that males had the higher proportion of those that were diagnosed with lung cancer. Of these, 70% of asian males were diagnosed with lung cancer, 63% of black males, 68% of mixed males and 60% of other ethnicity. 

```{r}
# Calculate the n and percent of patients by gender
bysex <- lung_cancer_patients_2013 %>%
  group_by(ETHNICITY, SEX) %>%
  count(ETHNICITY, SEX)

bysex <- bysex %>% group_by(ETHNICITY) %>% mutate(Percent = (n/sum(n) * 100), Patients = "All")
bysex[order(bysex$n, decreasing =T), ]

# 1.a. Sex distribution
bysex$label = paste0(sprintf("%.0f", bysex$Percent), "%")

ggplot(bysex, aes(x = ETHNICITY, y = Percent, fill = SEX)) + 
  geom_bar(position = "stack", stat='identity') + 
  geom_text(aes(label = label), position = position_stack(vjust = 0.5), size = 4) + coord_flip() + labs(x = "Ethnicity", y = "Percent (%)", title = " Gender Split by Ethnicity for Lung Cancer Patients Diagnosed in 2013") + scale_fill_discrete(name = "Sex") 
```

When breaking the ethnicities further, we can see that 80% of males from bangladesh and 70% of males from India were diagnosed with lung cancer. Of those that stated they were white (not British or Irish), the majority (69%) were female. It would be interesting to understand why there are such large gender imbalances across ethnicities for lung cancer patients in the data. 


_Data used artificial data from the Simulacrum, a synthetic dataset developed by Health Data Insight CiC derived from anonymous cancer data provided by the National Cancer Registration and Analysis Service, which is part of Public Health England_